<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Resultados da Análise - Analisador de Malware</title>
    <link rel="stylesheet" href="/static/css/style.css" />
    <style>
      .results-container {
        max-width: 920px;
        margin: 32px auto;
        padding: 20px;
      }
      .result-card {
        background: var(--card);
        border-radius: 16px;
        box-shadow: 0 10px 40px rgba(2,6,23,0.7);
        overflow: hidden;
        border: 1px solid var(--glass);
        padding: 20px;
        margin-bottom: 20px;
      }
      .result-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
      }
      .result-header h1 {
        margin: 0;
        font-size: 28px;
      }
      .back-button {
        background: var(--accent);
        color: white;
        padding: 10px 15px;
        border-radius: 8px;
        text-decoration: none;
        font-weight: bold;
      }
      .verdict-section {
        text-align: center;
        margin-bottom: 30px;
      }
      .verdict-text {
        font-size: 2.5em;
        font-weight: bold;
        margin-bottom: 10px;
      }
      .tags-text {
        color: var(--muted);
        font-size: 0.9em;
      }
      .section-title {
        color: var(--accent);
        margin-top: 30px;
        margin-bottom: 15px;
        border-bottom: 1px solid var(--glass);
        padding-bottom: 5px;
      }
      .external-service-card {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 10px;
      }
      .external-service-card h4 {
        margin-top: 0;
        color: var(--text);
      }
      .external-service-card p {
        margin: 5px 0;
        color: var(--muted);
      }
      .ai-analysis-content {
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid var(--glass);
        padding: 1rem;
        border-radius: 8px;
      }
      .vendor-analysis-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 10px;
        margin-top: 10px;
      }
      .vendor-item {
        display: flex;
        align-items: center;
        padding: 8px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 5px;
        font-size: 0.9em;
      }
      .vendor-icon {
        margin-right: 8px;
        font-size: 1.2em;
      }
      .vendor-name {
        font-weight: bold;
        margin-right: 5px;
      }
      .vendor-result {
        flex-grow: 1;
        text-align: right;
      }
      .vt-score-circle {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2em;
        font-weight: bold;
        color: white;
        border: 3px solid;
        box-sizing: border-box;
      }
      .vt-score-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 5px;
      }
    </style>
  </head>
  <body>
    <main class="results-container">
      <div class="result-header">
        <h1>Resultados da Análise</h1>
        <a href="/" class="back-button">Voltar para o Início</a>
      </div>

      <section class="result-card">
        <div class="verdict-section" id="verdict-section" style="border-radius: 8px;">
          <p class="verdict-text" id="final-verdict"></p>
          <p class="tags-text" style="display: none;">Tags: <span id="result-tags"></span></p>
        </div>

        <h2 class="section-title">Análises Externas</h2>
        <div id="external-results-display">
          {% if result.external %}
            {% for service_name, service_data in result.external.items() %}
              {% if service_name != 'local_analysis' %}
              <div class="external-service-card">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                  <h4>{{ service_name.capitalize() }}</h4>
                  {% if service_name == 'virustotal' and service_data.stats %}
                    {% set total_engines = service_data.stats.malicious + service_data.stats.suspicious + service_data.stats.harmless + service_data.stats.undetected %}
                    {% if total_engines > 0 %}
                      {% set risk_score_raw = (service_data.stats.malicious / total_engines) * 100 %}
                      {% set risk_score = risk_score_raw | round(0, 'floor') %}
                      {% set score_color = '#ff4b55' if risk_score_raw > 60 else ('#ffa426' if risk_score_raw > 30 else '#4caf50') %}
                      <div class="vt-score-container">
                        <div class="vt-score-circle" style="border-color: {{ score_color }}; color: {{ score_color }};">
                          {{ risk_score }}%
                        </div>
                        <small style="color: var(--muted);">Score de Risco</small>
                      </div>
                    {% endif %}
                  {% endif %}
                </div>
                {% if service_data.error %}
                  <p style="color: #ff4b55;">Erro: {{ service_data.error }}</p>
                {% elif service_data.found == False %}
                  <p style="color: var(--muted);">Não encontrado neste serviço.</p>
                {% else %}
                  {% if service_name != 'virustotal' %}
                    {% if service_data.verdict is defined %}
                      <p>Veredito: <strong style="color: {% if service_data.verdict == 'malicious' %}#ff4b55{% elif service_data.verdict == 'suspicious' %}#ffa426{% else %}#4caf50{% endif %};">{{ service_data.verdict.capitalize() }}</strong></p>
                    {% else %}
                      <p>Veredito: <strong style="color: var(--muted);">Não disponível</strong></p>
                    {% endif %}
                  {% endif %}
                  {% if service_name == 'virustotal' and service_data.stats %}
                    <p>Motores de detecção:</p>
                    <ul>
                      <li style="color: #ff4b55;">Maliciosos: {{ service_data.stats.malicious }}</li>
                      <li style="color: #ffa426;">Suspeitos: {{ service_data.stats.suspicious }}</li>
                      <li style="color: #4caf50;">Inofensivos: {{ service_data.stats.harmless }}</li>
                      <li style="color: var(--muted);">Não detectados: {{ service_data.stats.undetected }}</li>
                    </ul>
                    {% if service_data.security_vendors_analysis %}
                      <details style="margin-top: 15px; background: rgba(255, 255, 255, 0.03); border-radius: 8px; padding: 10px;">
                        <summary style="font-weight: bold; cursor: pointer; color: var(--accent);">Ver Análise Detalhada por Fornecedor</summary>
                        <div class="vendor-analysis-grid" style="padding-top: 10px;">
                          {% for vendor_name, vendor_result in service_data.security_vendors_analysis.items() %}
                            {% set category = vendor_result.category %}
                            {% set color = '#ff4b55' if category == 'malicious' else ('#ffa426' if category == 'suspicious' else ('#4caf50' if category == 'undetected' else '#6c757d')) %}
                            {% set icon = '&#x274C;' if category == 'malicious' else ('&#x26A0;' if category == 'suspicious' else ('&#x2705;' if category == 'undetected' else '&#x2754;')) %}
                            <div class="vendor-item" style="color: {{ color }};">
                              <span class="vendor-icon">{{ icon | safe }}</span>
                              <span class="vendor-name">{{ vendor_name }}:</span>
                              <span class="vendor-result">{{ vendor_result.result or category }}</span>
                            </div>
                          {% endfor %}
                        </div>
                      </details>
                    {% endif %}
                    {% if service_data.behaviour_summary and service_data.behaviour_summary|length > 0 %}
                      <details style="margin-top: 15px; background: rgba(255, 255, 255, 0.03); border-radius: 8px; padding: 10px;">
                        <summary style="font-weight: bold; cursor: pointer; color: var(--accent);">Ver Resumo de Comportamento (Sandbox)</summary>
                        <div class="behaviour-summary-content" style="padding-top: 10px;">
                          {% if service_data.behaviour_summary.has_detections %}
                            <p style="color: #ff4b55;"><strong>Detecções de Sandbox: SIM</strong></p>
                          {% else %}
                            <p style="color: #4caf50;"><strong>Detecções de Sandbox: NÃO</strong></p>
                          {% endif %}
                          {% if service_data.behaviour_summary.network_activity and service_data.behaviour_summary.network_activity|length > 0 %}
                            <p>Atividade de Rede Detectada.</p>
                          {% endif %}
                          {% if service_data.behaviour_summary.processes_created and service_data.behaviour_summary.processes_created|length > 0 %}
                            <p>Processos Criados Detectados.</p>
                          {% endif %}
                        </div>
                      </details>
                    {% endif %}
                  {% endif %}
                  {% if service_name == 'triage' and service_data.raw %}
                    <p>Score: {{ service_data.raw.score }}</p>
                    <p>Tags: {{ service_data.raw.tags | join(', ') }}</p>
                  {% endif %}
                {% endif %}
              </div>
              {% endif %} {# End if service_name != 'local_analysis' #}
            {% endfor %}
          {% else %}
            <p>Nenhum resultado de análise externa disponível.</p>
          {% endif %}
        </div>

        {% if result.ai_analysis %}
          <h2 class="section-title">Orientações de Segurança</h2>
          <div class="ai-analysis-content" id="ai-analysis-content"></div>
        {% endif %}
      </section>
    </main>

    <script>
      // Função para renderizar markdown de forma segura
      function renderMarkdown(text) {
          // Remove # do início de linhas (títulos Markdown)
          text = text.replace(/^#+\s*(.*)/gm, '$1');
          // Converte **texto** para <strong>texto</strong>
          text = text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
          // Converte *texto* para <em>texto</em>
          text = text.replace(/\*(.*?)\*/g, '<em>$1</em>');
          // Converte quebras de linha para <br>
          text = text.replace(/\n/g, '<br>');
          return text;
      }

      document.addEventListener('DOMContentLoaded', function() {
        const result = {{ result | tojson }};
        
        const verdictSectionEl = document.getElementById('verdict-section');
        const verdictEl = document.getElementById('final-verdict');
        const tagsEl = document.getElementById('result-tags');
        const aiContentEl = document.getElementById('ai-analysis-content');

        // Display final verdict
        let readableVerdict = 'Desconhecido';
        let verdictBgColor = '';
        let verdictTextColor = 'var(--text)';

        if (result.final_verdict === 'malicious') {
          readableVerdict = 'MALICIOSO';
          verdictBgColor = '#ff4b55';
          verdictTextColor = 'white';
        } else if (result.final_verdict === 'suspicious') {
          readableVerdict = 'SUSPEITO';
          verdictBgColor = '#ffa426';
          verdictTextColor = 'white';
        } else if (result.final_verdict === 'clean' || result.final_verdict === 'safe') {
          readableVerdict = 'SEGURO';
          verdictBgColor = '#4caf50';
          verdictTextColor = 'white';
        }
        verdictEl.textContent = `VEREDITO FINAL: ${readableVerdict}`;
        verdictSectionEl.style.backgroundColor = verdictBgColor;
        verdictEl.style.color = verdictTextColor;

        // Display tags
        if (result.tags && result.tags.length > 0) {
          tagsEl.textContent = result.tags.join(', ');
        } else {
          tagsEl.textContent = 'Nenhuma tag.';
        }

        // Display AI analysis
        if (result.ai_analysis && result.ai_analysis.explanation) {
          aiContentEl.innerHTML = renderMarkdown(result.ai_analysis.explanation);
        } else if (result.ai_analysis && result.ai_analysis.error) {
          aiContentEl.innerHTML = `<p style="color: #ff4b55;"><strong>Erro na Análise por IA:</strong> ${result.ai_analysis.error}</p>`;
        }
      });
    </script>
  </body>
</html>
